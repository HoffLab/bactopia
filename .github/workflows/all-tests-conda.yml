name: All Bactopia Tests (Conda)

on: workflow_dispatch
  #schedule:
    # At 01:30 on Monday and Thursday
    #- cron:  '30 1 * * 1,4'

jobs:
  pytest-bactopia:
    runs-on: olaf
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - name: Checkout bactopia/bactopia
        uses: actions/checkout@v2
        with:
          path: ${{ github.run_id }}/bactopia

      - name: Setup ENV variables
        run: |
          echo "BACTOPIA_CI=/data/storage/bactopia-ci" >> $GITHUB_ENV
          echo "BACTOPIA_CONDA=/data/storage/bactopia-ci/envs/conda" >> $GITHUB_ENV
          echo "BACTOPIA_TESTS=/data/storage/bactopia-ci/bactopia-tests/data" >> $GITHUB_ENV
          echo "BACTOPIA_WORKSPACE=${GITHUB_WORKSPACE}/${{ github.run_id }}" >> $GITHUB_ENV
          echo "BACTOPIA_TMP=/tmp/gh-runner-${{ github.run_id }}" >> $GITHUB_ENV
          mkdir ${{ env.BACTOPIA_TMP }}
          source ${BACTOPIA_CI}/miniconda3/etc/profile.d/conda.sh
          conda activate bactopia-ci
          cd ${{ env.BACTOPIA_WORKSPACE }}/bactopia
          uname -a && env
          pwd

      - name: Run Bactopia Tests (per module)
        run: |
          ls modules/local/bactopia | xargs -I {} \
              bash -c 'BACTOPIA_ARGS="--condadir ${{ env.BACTOPIA_CONDA }} --test_data_dir ${{ env.BACTOPIA_TESTS }}" TMPDIR=${{ env.BACTOPIA_TMP }} \
                       pytest --wt 20 --symlink --kwdof -o "testpaths=modules/local/bactopia" --tag {}'

      - name: Run Bactopia Tools Tests (per tools)
        run: |
          ls subworkflows/local/bactopia | xargs -I {} \
              bash -c 'BACTOPIA_ARGS="--condadir ${{ env.BACTOPIA_CONDA }} --test_data_dir ${{ env.BACTOPIA_TESTS }}" TMPDIR=${{ env.BACTOPIA_TMP }} \
                       pytest --wt 20 --symlink --kwdof "testpaths=subworkflows/local/" --tag {}'

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: logs-debian
          path: |
            /tmp/gh-runner-${{ github.run_id }}/pytest_workflow_*/*/log.out
            /tmp/gh-runner-${{ github.run_id }}/pytest_workflow_*/*/log.err
            
      - name: Cleanup
        if: always()
        run: rm -rf ${{ github.run_id }} /tmp/gh-runner-${{ github.run_id }}
